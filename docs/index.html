<!DOCTYPE html>
<html>
  <head>
    <title>Pomudoro üçÇ Work with Pomu!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Ubuntu, sans-serif;
      }

      html,
      body {
        width: 100%;
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #cfeded;
        padding: 2rem;
      }

      body::before,
      body::after {
        position: absolute;
        height: 2rem;
        width: 100%;
        background-color: #65b2a1;
        content: " ";
      }

      body::before {
        top: 0;
      }

      body::after {
        bottom: 0;
      }

      #container {
        max-width: 40rem;
      }

      h1 {
        font-size: 4rem;
        margin-bottom: 2rem;
        color: #65b2a1;
      }

      #pomudoroButtons {
        display: flex;
      }

      #startstop,
      #skip,
      #skipBreak {
        background: white;
        border: 0.5rem solid #65b2a1;
        box-shadow: 2px 2px 1px #65b2a1;
        border-radius: 4px;
        color: black;
        cursor: pointer;
      }

      #startstop:active,
      #skip:active {
        box-shadow: 0 0 0 #65b2a1;
        transform: translate(2px, 2px);
      }

      #startstop {
        width: 100%;
        padding: 2rem;
        font-size: 2rem;
      }

      #skip {
        margin-left: 1rem;
        padding: 2rem;
        font-size: 2rem;
        display: none;
      }

      #skip.show {
        display: block;
      }

      #skipBreak {
        margin-top: 1rem;
        visibility: hidden;
        width: 100%;
        padding: 1rem;
        font-size: 1.5rem;
      }

      #skipBreak.show {
        visibility: visible;
      }

      #decoration {
        position: fixed;
        bottom: 0;
        right: 0;
        height: 20rem;
        width: 20rem;
        z-index: 100;

        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      #flavor {
        color: black;
        font-weight: bold;
        font-size: 1.5rem;
      }

      #pomuBox {
        flex-grow: 1;
        overflow: hidden;
        text-align: center;
      }

      #pomu {
        max-width: 100%;
        max-height: 100%;
        height: auto;
        width: auto;
      }

      @media (max-width: 50rem) {
        #decoration {
          height: 10rem;
          width: 10rem;
        }

        #flavor {
          font-size: 1rem;
        }
      }

      #config {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 20rem;
      }

      summary {
        cursor: pointer;
        list-style: none;
        position: absolute;
        top: 8px;
        right: 8px;
      }

      fieldset {
        border: none;
        width: 100%;
        min-width: 100%;
      }

      fieldset + fieldset {
        margin-top: 1rem;
      }

      legend {
        margin-bottom: 0.5rem;
      }

      #pomudachi {
        width: 2rem;
        position: absolute;
        top: 0;
        right: 0;
      }

      details {
        display: flex;
        flex-direction: column;
        padding: 2rem;
      }

      details[open] {
        border: 4px solid #86c699;
        border-radius: 4px;
        background: white;
      }

      input[type="number"] {
        display: block;
        min-width: 0;
        border: 2px solid #86c699;
        -moz-appearance: textfield;
      }

      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
      }

      #timeControls,
      #breakControls {
        display: flex;
        width: 100%;
      }

      .numAdjust {
        width: 3rem;
        height: 2rem;
        border: 2px solid #86c699;
        border-radius: 4px;
        background: white;
        cursor: pointer;
      }

      .numAdjust:hover {
        background: #86c699;
      }

      #timerLength,
      #breakLength {
        flex-shrink: 1;
        flex-grow: 1;
        height: 2rem;
        padding: 0 0.5rem;
        margin: 0 0.5rem;
      }
    </style>
    <script type="text/javascript">
      const NUM_SOUNDS = 14;
      const FRAME_LENGTH = 500;
      const WORK_GIFS = [
        "baseball.gif",
        "cash.gif",
        "choo_choo.gif",
        "cursed_pizza.gif",
        "cyclone.gif",
        "jump_rope.gif",
        "kecha.gif",
        "pomu.gif",
        "pomutori.gif",
        "skate.gif",
        "sword.gif",
      ];
      const IDLE_GIF = "pomuJAM.gif";
      const DONE_GIF = "ppbirthday2021.gif";
      const REST_GIF = "cursed_pizza.gif";

      /*
      idle -> working -> done -> resting -> idle
                 ^                  ^
                 |                  |
                 v                  v
              paused             paused
      */
      let state = "idle";
      let cycles = 0;
      let pomudoroLength = 25 * 60;
      let shortBreakLength = 5 * 60;
      let longBreakLength = 15 * 60;
      let cyclesPerLongBreak = 4;
      let timeRemaining = pomudoroLength;
      let interval = -1;

      let currentSprite = IDLE_GIF;
      let spriteFrame = 0;
      let frameOffset = 0;
      let lastFrame = 0;

      /*
      =================
      Utility Functions
      =================
      */
      function pad(num) {
        if (num < 10) {
          return `0${num}`;
        }
        return `${num}`;
      }

      function log(event) {
        if (window.umami) {
          try {
            umami(event);
          } catch {}
        }
      }

      function formatTime(time) {
        // TODO: assumes it's never an hour
        return `${pad(Math.floor(time / 60))}:${pad(Math.floor(time) % 60)}`;
      }

      /*
      ======================
      Cycle State Management
      ======================
      */
      function unpause() {
        interval = setInterval(tick, 1000);
        updateInterface();
      }

      function pause() {
        clearInterval(interval);
        interval = -1;
        updateInterface();
      }

      function start(timerLength) {
        timeRemaining = timerLength;
        drawCountdown();
        updateInterface();
        setGif();
        unpause();
      }

      function stop(nextCycleTime) {
        clearInterval(interval);
        interval = -1;
        timeRemaining = nextCycleTime;
        drawCountdown();
        updateInterface();
      }

      function completeSegment() {
        imPomu();
        if (state === "working") {
          if (nextBreakIsLong()) {
            stop(longBreakLength);
          } else {
            stop(shortBreakLength);
          }

          state = "done";
          updateInterface();
          setGif();
        } else if (state === "resting") {
          stop(pomudoroLength);

          cycles += 1;
          state = "idle";
          updateInterface();
          setGif();
        }
      }

      function startBreak() {
        log("Start Break");
        if (nextBreakIsLong()) {
          start(longBreakLength);
        } else {
          start(shortBreakLength);
        }
      }

      function nextBreakIsLong() {
        if ((cycles + 1) % cyclesPerLongBreak === 0) {
          return true;
        } else {
          return false;
        }
      }

      // TODO: add flavor, gif
      // figure out what to do with skip break button. remove?
      function updateInterface() {
        const startStopButton = document.getElementById("startstop");
        const skipButton = document.getElementById("skip");
        const flavor = document.getElementById("flavor");

        if (state === "idle") {
          startStopButton.innerText = "Start Pomudoro";
          skipButton.classList.remove("show");
          flavor.innerText = "Pomu is idle";
        } else if (state === "working") {
          skipButton.classList.add("show");
          flavor.innerText = "Pomu is working";
          if (interval !== -1) {
            startStopButton.innerText = "Pause Pomudoro";
          } else {
            startStopButton.innerText = "Resume Pomudoro";
          }
        } else if (state === "done") {
          flavor.innerText = "Pomu is done!";
          if (nextBreakIsLong()) {
            startStopButton.innerText = "Start Long Break";
          } else {
            startStopButton.innerText = "Start Short Break";
          }
          skipButton.classList.remove("show");
        } else if (state === "resting") {
          flavor.innerText = "Pomu is resting";
          skipButton.classList.add("show");
          if (interval !== -1) {
            if (nextBreakIsLong()) {
              startStopButton.innerText = "Pause Long Break";
            } else {
              startStopButton.innerText = "Pause Short Break";
            }
          } else {
            if (nextBreakIsLong()) {
              startStopButton.innerText = "Resume Long Break";
            } else {
              startStopButton.innerText = "Resume Short Break";
            }
          }
        }
      }

      /*
      ===================
      Interface rendering
      ===================
      */
      function imPomu() {
        const audio = new Audio(
          `sounds/pomu${pad(Math.floor(Math.random() * NUM_SOUNDS))}.mp3`
        );
        audio.play();
      }

      function drawCountdown() {
        const formatted = formatTime(timeRemaining);
        document.getElementById("countdown").textContent = formatted;
      }

      function tick() {
        timeRemaining -= 1;
        drawCountdown();
        if (timeRemaining <= 0 && interval !== -1) {
          completeSegment();
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        drawCountdown();
        updateInterface();
      });

      function setGif() {
        let gif = IDLE_GIF;
        if (state === "idle") {
          pomu.src = `gifs/${IDLE_GIF}`;
        } else if (state === "working") {
          gif = WORK_GIFS[Math.floor(Math.random() * WORK_GIFS.length)];
        } else if (state === "done") {
          gif = DONE_GIF;
        } else if (state === "resting") {
          gif = REST_GIF;
        }
        document.getElementById("pomu").src = `gifs/${gif}`;
      }

      /*
      ===============
      Button Handlers
      ===============
      */
      function startstop() {
        if (state === "idle") {
          log("Start Pomudoro");
          state = "working";
          updateInterface();
          setGif();
          start(pomudoroLength);
        } else if (state === "working" || state === "resting") {
          if (interval !== -1) {
            console.log("Pausing");
            pause();
          } else {
            console.log("Unpausing");
            unpause();
          }
        } else if (state === "done") {
          state = "resting";
          setGif();
          startBreak();
        }
      }

      function skip() {
        completeSegment();
      }
    </script>
    <script
      async
      defer
      data-website-id="4c03626b-f6cf-40fc-a9d1-6e5899960fb7"
      src="https://stats.speculative.tech/umami.js"
    ></script>
  </head>
  <body>
    <div id="container">
      <h1>Pomudoro Timer</h1>
      <svg viewBox="0 0 40 20">
        <text id="countdown" x="0" y="16"></text>
      </svg>
      <div id="buttons">
        <div id="pomudoroButtons">
          <button id="startstop" onclick="startstop()">Start Pomudoro</button>
          <button id="skip" onclick="skip()">>></button>
        </div>
        <button id="skipBreak" onclick="skipBreak()">Skip Break</button>
      </div>
      <div id="config">
        <details>
          <summary>
            <img title="Settings" id="pomudachi" src="pomudachi.webp" />
          </summary>
          <fieldset id="timeConfig">
            <legend>Timer length</legend>
            <div id="timeControls">
              <button id="reduceTime" class="numAdjust">-</button>
              <input
                id="timerLength"
                type="number"
                step="5"
                min="5"
                max="60"
                value="25"
              />
              <button id="increaseTime" class="numAdjust">+</button>
            </div>
          </fieldset>
          <fieldset id="breakConfig">
            <legend>Break length</legend>
            <div id="breakControls">
              <button id="reduceBreak" class="numAdjust">-</button>
              <input
                id="breakLength"
                type="number"
                step="1"
                min="1"
                max="20"
                value="5"
              />
              <button id="increaseBreak" class="numAdjust">+</button>
            </div>
          </fieldset>
        </details>
      </div>
      <div id="decoration">
        <div id="flavor">Pomu is idle</div>
        <div id="pomuBox">
          <img id="pomu" src="gifs/pomuJAM.gif" />
        </div>
      </div>
    </div>
  </body>
</html>
